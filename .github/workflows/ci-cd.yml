name: AI QA System CI/CD

on:
  push:
    branches: [ main]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip unit tests'
        type: boolean
        default: false
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  SHOULD_SKIP_TESTS: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_tests == 'true') || contains(github.event.head_commit.message, '[skip tests]') || vars.SKIP_TESTS == 'true' }}

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: fronted/package-lock.json

    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    - name: Run backend tests
      if: false  # æ°¸ä¹…è·³è¿‡æµ‹è¯•
      run: |
        cd backend-services
        mvn -B clean test

    - name: Build backend without tests
      if: ${{ env.SHOULD_SKIP_TESTS == 'true' }}
      run: |
        cd backend-services
        mvn -B -DskipTests package
    - name: Install frontend dependencies
      run: |
        cd fronted
        npm ci

    - name: Run frontend linting
      run: |
        cd fronted
        npm run lint

    - name: Run frontend build
      run: |
        cd fronted
        npm run build

  # æ„å»ºDockeré•œåƒ
  build-images:
    needs: code-quality
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    strategy:
      matrix:
        service: [api-gateway, user-service, qa-service, frontend]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.service }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ${{ matrix.service == 'frontend' && './fronted' || './backend-services' }}
        file: ${{ matrix.service == 'frontend' && './fronted/Dockerfile' || format('./backend-services/{0}/Dockerfile', matrix.service) }}
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # å®‰å…¨æ‰«æ
  security-scan:
    needs: build-images
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    timeout-minutes: 10  # æ·»åŠ è¶…æ—¶

    steps:
    - uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        scanners: 'vuln'  # åªæ‰«ææ¼æ´ï¼Œè·³è¿‡å¯†é’¥æ‰«æä»¥åŠ é€Ÿ
        severity: 'CRITICAL,HIGH'  # åªæŠ¥å‘Šä¸¥é‡å’Œé«˜å±æ¼æ´

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
  deploy-dev:
    needs: build-images
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/feature/')

    steps:
    - uses: actions/checkout@v4

    - name: Deploy to development
      run: |
        echo "ğŸš€ Deploying to development environment..."
        echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯:"
        echo "  - æœåŠ¡å™¨: 54.234.25.135"
        echo "  - åˆ†æ”¯: feature/yulong"
        echo "  - é•œåƒ: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"

        echo "ğŸ”§ éƒ¨ç½²æ­¥éª¤:"
        echo "1. æ„å»ºçš„Dockeré•œåƒå·²æ¨é€åˆ°GitHub Container Registry"
        echo "2. é•œåƒæ ‡ç­¾: ${{ github.ref_name }}-${{ github.sha }}"
        echo "3. éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šæ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤:"
        echo ""
        echo "   # SSHåˆ°æœåŠ¡å™¨"
        echo "   ssh ubuntu@54.234.25.135"
        echo ""
        echo "   # è¿›å…¥é¡¹ç›®ç›®å½•"
        echo "   cd /home/ubuntu/ai-qa-system || (mkdir -p /home/ubuntu/ai-qa-system && cd /home/ubuntu/ai-qa-system)"
        echo ""
        echo "   # å…‹éš†æˆ–æ›´æ–°ä»£ç "
        echo "   if [ ! -d .git ]; then"
        echo "     git clone https://github.com/pzone618/ai-qa-system.git ."
        echo "   fi"
        echo "   git fetch origin"
        echo "   git checkout feature/yulong"
        echo "   git pull origin feature/yulong"
        echo ""
        echo "   # åœæ­¢æ—§å®¹å™¨å¹¶å¯åŠ¨æ–°å®¹å™¨"
        echo "   docker-compose down || true"
        echo "   docker-compose up -d --build"
        echo ""
        echo "   # æ£€æŸ¥æœåŠ¡çŠ¶æ€"
        echo "   docker-compose ps"
        echo "   curl -f http://localhost:3000/ || echo 'å‰ç«¯æœåŠ¡æ£€æŸ¥å¤±è´¥'"
        echo ""
        echo "âœ… éƒ¨ç½²æŒ‡ä»¤å·²ç”Ÿæˆï¼Œè¯·æ‰‹åŠ¨åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä¸Šè¿°å‘½ä»¤"

    - name: Run health checks
      run: |
        echo "ğŸ¥ Running health checks..."
        echo "ğŸ“‹ å¥åº·æ£€æŸ¥è¯´æ˜:"
        echo "ç”±äºéƒ¨ç½²éœ€è¦æ‰‹åŠ¨æ‰§è¡Œï¼Œå¥åº·æ£€æŸ¥å°†åœ¨éƒ¨ç½²å®Œæˆåè¿›è¡Œ"
        echo ""
        echo "ğŸ” æ‰‹åŠ¨å¥åº·æ£€æŸ¥å‘½ä»¤:"
        echo "   # æ£€æŸ¥å‰ç«¯æœåŠ¡"
        echo "   curl -f http://54.234.25.135:3000/login/ && echo 'âœ… å‰ç«¯æœåŠ¡æ­£å¸¸' || echo 'âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸'"
        echo ""
        echo "   # æ£€æŸ¥APIç½‘å…³"
        echo "   curl -f http://54.234.25.135:8080/actuator/health && echo 'âœ… APIç½‘å…³æ­£å¸¸' || echo 'âš ï¸  APIç½‘å…³å¼‚å¸¸'"
        echo ""
        echo "   # æ£€æŸ¥æ‰€æœ‰å®¹å™¨çŠ¶æ€"
        echo "   docker-compose ps"
        echo ""
        echo "âœ… å¥åº·æ£€æŸ¥æŒ‡ä»¤å·²ç”Ÿæˆ"

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-prod:
    needs: [build-images, security-scan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
    - uses: actions/checkout@v4

    - name: è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ EC2
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        script: |
          # å®šä¹‰é¡¹ç›®ç›®å½•å˜é‡
            PROJECT_DIR="/home/ubuntu/ai-qa-system"
          
            # åœæ­¢å¹¶åˆ é™¤å¯èƒ½åœ¨è¿è¡Œçš„ç›¸å…³å®¹å™¨ï¼Œé¿å…æ–‡ä»¶å ç”¨
            if [ -d "$PROJECT_DIR" ]; then
              cd "$PROJECT_DIR"
              docker-compose down || true
            fi
          
            # æ— è®ºå¦‚ä½•ï¼Œéƒ½å…ˆå½»åº•åˆ é™¤æ—§çš„ç›®å½•ï¼Œç¡®ä¿ä¸€ä¸ªå¹²å‡€çš„ç¯å¢ƒ
            echo "ğŸ§¹ æ­£åœ¨æ¸…ç†æ—§çš„éƒ¨ç½²ç›®å½•: $PROJECT_DIR"
            rm -rf "$PROJECT_DIR"
          
            # é‡æ–°åˆ›å»ºç›®å½•å¹¶è¿›å…¥
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"

            # ä»ä¸€ä¸ªå¹²å‡€çš„ç›®å½•å¼€å§‹å…‹éš†
            echo "ğŸšš æ­£åœ¨ä» GitHub å…‹éš†æœ€æ–°çš„ä»£ç ..."
            git clone https://github.com/tianyf925/ai-qa-system.git .
          
            # æ£€æŸ¥å…‹éš†æ˜¯å¦æˆåŠŸ
            if [ ! -f "docker-compose.yml" ]; then
              echo "âŒ Git å…‹éš†å¤±è´¥ï¼Œæ‰¾ä¸åˆ° docker-compose.yml æ–‡ä»¶ã€‚"
              exit 1
            fi

            # é‡ç½®åˆ°è§¦å‘æœ¬æ¬¡å·¥ä½œæµçš„é‚£ä¸ª commit
            echo "ğŸ”„ æ­£åœ¨é‡ç½®ä»£ç åˆ° commit: ${{ github.sha }}"
            git reset --hard ${{ github.sha }}

            echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
            echo "ä½¿ç”¨ Docker Compose æ„å»ºå¹¶å¯åŠ¨æœåŠ¡..."
            docker-compose up -d --build
          
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨ (90ç§’)..."
            sleep 90
          
            echo "ğŸ¥ æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            docker-compose ps
          
            echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            curl -f http://localhost:3000/login/ || echo 'âŒ å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥'
            curl -f http://localhost:8080/actuator/health || echo 'âŒ API Gatewayå¥åº·æ£€æŸ¥å¤±è´¥'
          
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"

    - name: Run health checks
      run: |
        echo "ğŸ¥ Running production health checks..."
        echo "ğŸ“‹ ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥è¯´æ˜:"
        echo "ç”±äºéƒ¨ç½²éœ€è¦æ‰‹åŠ¨æ‰§è¡Œï¼Œå¥åº·æ£€æŸ¥å°†åœ¨éƒ¨ç½²å®Œæˆåè¿›è¡Œ"
        echo ""
        echo "ğŸ” æ‰‹åŠ¨å¥åº·æ£€æŸ¥å‘½ä»¤:"
        echo "   # æ£€æŸ¥å‰ç«¯æœåŠ¡"
        echo "   curl -f http://54.234.25.135:3000/login/ && echo 'âœ… å‰ç«¯æœåŠ¡æ­£å¸¸' || echo 'âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸'"
        echo ""
        echo "   # æ£€æŸ¥APIç½‘å…³"
        echo "   curl -f http://54.234.25.135:8080/actuator/health && echo 'âœ… APIç½‘å…³æ­£å¸¸' || echo 'âš ï¸  APIç½‘å…³å¼‚å¸¸'"
        echo ""
        echo "   # æ£€æŸ¥æ‰€æœ‰å®¹å™¨çŠ¶æ€"
        echo "   docker-compose ps"
        echo ""
        echo "âœ… ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥æŒ‡ä»¤å·²ç”Ÿæˆ"

    - name: Notify deployment success
      run: |
        echo "âœ… Production deployment instructions generated successfully!"
        echo "ğŸŒ ç”Ÿäº§ç¯å¢ƒè®¿é—®åœ°å€: http://54.234.25.135:3000"
        echo "ğŸ”— APIç½‘å…³åœ°å€: http://54.234.25.135:8080"

  # æ€§èƒ½æµ‹è¯•
  performance-test:
    needs: deploy-dev
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/feature/')

    steps:
    - uses: actions/checkout@v4

    - name: Run performance tests
      run: |
        echo "âš¡ Running performance tests..."
        # å¯ä»¥é›†æˆ k6, JMeter æˆ–å…¶ä»–æ€§èƒ½æµ‹è¯•å·¥å…·

  # # æ¸…ç†æ—§é•œåƒ
  # cleanup:
  #   needs: [deploy-dev, deploy-prod]
  #   runs-on: ubuntu-latest
  #   if: always()

    # steps:
    # - name: Delete old container images
    #   uses: actions/delete-package-versions@v4
    #   with:
    #     package-name: ${{ env.IMAGE_NAME }}-api-gateway-yulong
    #     package-type: container
    #     min-versions-to-keep: 5
    #     delete-only-untagged-versions: true
